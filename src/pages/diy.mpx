<template>
  <view class="diy-background">
    <view class="canvas-container">
      <canvas-drag class="canvas-drag" id="canvas-drag" width="{{676}}" height="{{846}}"graph="{{graph}}" enableUndo="{{true}}"></canvas-drag>
      <button bindtap="publish" class="operation-btn"/>
      <!-- <view class="btn" bindtap="onAddImage">添加图片</view>
      <view class="btn" bindtap="onAddText">添加文字</view>
      <view class="btn" bindtap="onExport">导出图片</view>
      <view class="btn" bindtap="onChangeColor">改变文字颜色</view>
      <view class="btn" bindtap="onChangeBgColor">改变背景颜色</view>
      <view class="btn" bindtap="onExportJSON">导出模板</view>
      <view class="btn" bindtap="onImport">导入默认模板</view>
      <view class="btn" bindtap="onClearCanvas">清空</view>
      <view class="btn" bindtap="onChangeBgImage">改变背景照片</view>
      <view class="btn" bindtap="onUndo">后退</view> -->
    </view>
    <view class="change-container">
      <view class="operation-list">
        <view bindtap="changeSelect(1)" class="change-btn {{typeSelect===1 ? 'change-select' : ''}}">底图</view>
        <view bindtap="changeSelect(2)" class="change-btn {{typeSelect===2 ? 'change-select' : ''}}">元素</view>
      </view>
      <view class="image-container">
        <view class="image-wrapper" wx:for="{{showList}}" wx:key="item" wx:style="{{iconStyle}}">
          <image class="image-style" src="{{item}}" bindtap="changeImage(item)"/>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
  import mpx,{ createPage } from '@mpxjs/core'
  // import VerticalNavPage from './vertical-nav?resolve'
  import CanvasDrag from '../../scripts/canvas-drag';
  createPage({
      data: {
          graph: {},
          vip:0,
          bgImageList:['https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg'],
          iconList:{
            VIP1:['https://static-qa.yimutea.com/test/%E7%B4%A0%E6%9D%90_%E6%A4%8D%E7%89%A91%403x.png','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg'],
            VIP2:['https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg'],
            VIP3:['https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg'],
            VIP4:['https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg'],
            VIP5:['https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg'],
            VIP6:['https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg'],
            VIP7:['https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg','https://p.qqan.com/up/2021-1/202118103317306.jpg'],
          },
          vipList:['VIP1','VIP2','VIP3','VIP4','VIP5','VIP6','VIP7','VIP8'],
          typeSelect:1,
          vipSelect:'VIP1',
          showList:[]
      },
      onReady(){
        this.changeSelect(1)
      },
      computed:{
        iconStyle(){
          const IconBg = "https://static-qa.yimutea.com/test/%E7%B4%A0%E6%9D%90%E9%80%8F%E6%98%8E%E6%A1%86%403x.png"
          return this.typeSelect===2 ? `background-image:url(${IconBg});background-size:100% 100%;`:''
        }
      },
      onLoad(params){
        this.vip = params.vip
      },
      methods:{
        /**
         * 添加图片
         */
        onAddImage() {
          let proportion
          let h = 200
          wx.downloadFile({
            url: 'https://static-qa.yimutea.com/test/%E5%BD%A9%E8%89%B2%E6%B5%81%E6%98%9F%E9%9B%A8.PNG', 
            success: (res) => {
              this.graph = {
                    w: 400,
                    h: 500,
                    type: 'image',
                    url: res.tempFilePath,
                  }
              }
          })
          // wx.chooseImage({
          //   success: (res) => {
          //     wx.getImageInfo({
          //       src: res.tempFilePaths[0],
          //       success (res) {
          //         proportion = res.height / res.width
          //         h = h * proportion
          //       }
          //     })
          //     this.setData({
          //         graph: {
          //           w: 200,
          //           h: h,
          //           type: 'image',
          //           url: res.tempFilePaths[0],
          //         }
          //     });
          //   }
          // })
        },

        /**
         * 添加文本
         */
        onAddText() {
            this.setData({
                graph: {
                    type: 'text',
                    text: 'helloworld',
                }
            });
        },

        /**
         * 导出图片
         */
        onExport() {
            CanvasDrag.export()
                .then((filePath) => {
                    wx.previewImage({
                        urls: [filePath]
                    })
                })
                .catch((e) => {
                    console.error(e);
                })
        },

        /**
         * 改变文字颜色
         */
        onChangeColor() {
            CanvasDrag.changFontColor('blue');
        },

        /**
         * 改变背景颜色
         */
        onChangeBgColor() {
            CanvasDrag.changeBgColor('yellow');
        },

        /**
         * 改变背景照片
         */
        onChangeBgImage() {
            wx.downloadFile({
              url:'https://static-qa.yimutea.com/test/%E8%83%8C%E6%99%AF.PNG',
              success(res){
                var imgUrl= res.tempFilePath;
                CanvasDrag.changeBgImage(imgUrl);
              }
            })
        },

        /**
         * 导出当前画布为模板
         */
        onExportJSON(){
            CanvasDrag.exportJson()
              .then((imgArr) => {
                console.log(JSON.stringify(imgArr));
            })
              .catch((e) => {
                  console.error(e);
              });
        },

        onImport(){
            // 有背景
            // let temp_theme = [{"type":"bgColor","color":"yellow"},{"type":"image","url":"../../assets/images/test.jpg","y":98.78423143832424,"x":143.78423143832424,"w":104.43153712335152,"h":104.43153712335152,"rotate":-12.58027482265038,"sourceId":null},{"type":"text","text":"helloworld","color":"blue","fontSize":24.875030530031438,"y":242.56248473498428,"x":119.57012176513672,"w":116.73966979980469,"h":34.87503053003144,"rotate":8.873370699754087}];
            // 无背景
            let temp_theme = [{"type":"image","url":"../../assets/images/test.jpg","y":103,"x":91,"w":120,"h":120,"rotate":0,"sourceId":null},{"type":"text","text":"helloworld","color":"blue","fontSize":20,"y":243,"x":97,"rotate":0}];

            CanvasDrag.initByArr(temp_theme);
        },

        onClearCanvas:function(event){
          let _this = this;
          _this.setData({canvasBg:null});
          CanvasDrag.clearCanvas();
        },

        onUndo:function(event){
            CanvasDrag.undo();
        },
        publish(){

        },
        changeSelect(index){
          this.typeSelect = index
          if (index===1) {
            this.showList = this.bgImageList
          } else {
            this.showList = this.iconList[this.vipSelect]
          }
        },
        changeVIP(item){
          this.vipSelect = item
          this.showList = this.iconList[item]
        },
        changeImage(imageSrc){
          if(this.typeSelect === 1){
            this.onChangeBgImage(imageSrc)
          }else{
            this.onAddImage(imageSrc)
          }
        }
      }
  });
</script>
<style lang="stylus">
  .diy-background
      height 100%
      min-height 100vh
      width 100vw
      background-image url('https://static-qa.yimutea.com/test/home_bg.png')
      background-size 100% 100%
  .btn{
    padding: 10rpx 20rpx;
    float:left;
    margin:10rpx;
    border:solid 1px #dfdfdf;
    border-radius: 10rpx;
  }
  .canvas-drag
    margin 20px 18px 0 18px
    width calc(100vw - 36px)
    /*use rpx*/
    height 846rpx
  .canvas-container
    /*use rpx*/
    height:1000rpx;
    width: 100vw
    box-sizing: border-box;
    background-size 100% 100%
    display flex
    position relative
    justify-content center
    background-image: url('https://static-qa.yimutea.com/test/%E5%8C%BA%E5%9F%9F%E8%83%8C%E6%99%AF%403x.png')
  .operation-btn
    height 30px
    width 78px
    background-image url('https://static-qa.yimutea.com/test/%E5%8F%91%E5%B8%83%403x.png')
    background-size 100% 100%
    position absolute
    right 20px
    bottom 10px
  .change-container
    padding 10px 17px 20px 17px
  .operation-list
    display:flex;
    justify-content flex-start
    overflow-x scroll
    width: 100%;
  .change-select
    background-image url('https://static-qa.yimutea.com/test/%E9%80%89%E4%B8%AD%E8%83%8C%E6%99%AF%403x.png')
    background-size 100% 100%
    width 56px
    height 30px
    color #fff !important
  .change-btn
    height 30px
    line-height 30px
    width 56px
    color #A1A4E3
    text-align center
  .image-container 
    display: flex;
    width: 100%;
    flex-wrap: wrap;
    justify-content: space-evenly;
    margin-right: -10px;
  .image-wrapper
    width 24%
    /*use rpx*/
    height 160rpx
    display flex
    justify-content center
    margin-top: 12px
  .image-style
      /*use rpx*/
      width 160rpx
      /*use rpx*/
      height 160rpx
  .image-wrapper:last-child:nth-child(4n-1) {
      margin-right: calc(24% + 2% / 3);
  }
  .image-wrapper:last-child:nth-child(4n-2) {
      margin-right: calc(48% + 4% / 3);
  }
  .image-wrapper:last-child:nth-child(4n-3) {
      margin-right: calc(72% + 8% / 3);
  }
</style>
<script type="application/json">
  {
    "usingComponents": {
      "canvas-drag": "../components/canvas-drag"
    }
  }
</script>
